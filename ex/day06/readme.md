# day06: データサイエンス，機械学習（パターン認識）入門

データサイエンスにせよ，機械学習にせよ，データをデータフレームにまとめることから始まります．

データフレームとは，
- 計測項目または質問項目を各列（縦ベクトル）に並べ，サンプル（標本，被験者）が増えれば行を増やして項目を埋めていった表．

次のような表です．

|index|ID|好きな動物|動物占いの判定|誕生月|セロリ嗜好|歩数|BMI|
|---|---|---|---|---|----|---|---|
| | | | | | | | |

被験者（アンケート回答者）が増えれば行が増えていきます．
-  index: 被験者が増えれば1増やしていくような数です．単に実験者が被験者につけた番号です．

データフレームは，CSV（Comma-Separated-Values）形式での保存が一般的です．

上記のデータフレームは，

```csv
# mydata1.csv
ID, 好きな動物, 動物占いの判定, 誕生月, セロリ嗜好, 歩数, BMI
aa83988848, くま, たぬき, 5, 嫌い, 3192, 26
```

のようなファイルになります．行ごとに列の文字数が異なるので，多少読みにくいですが，そもそもヒトが読むものではなく，計算機が読むためのものなので我慢です．

CSV形式はMicrosoft Excelなどの表計算ソフトのフォーマットと相互に変換できます．ヒトが読む場合は表計算ソフトで読み書きするのがいいでしょう．ExcelならCSVファイルを読み込むだけ，保存するときもCSVフォーマットを選ぶだけ．

また，データフレームに直せそうなデータをなんとかしてデータフレームに直すことを，スクレイピング（scraping）と呼んでいます．たとえば，コロナウイルスの陽性者数などの表はpdfで公開されていたりしますが，画像であるPDFから表の罫線を読み取って，罫線で区切られる数字や文字列を認識して，データフレームに直すなんてことだったりが，スクレイピングです．

さて，このCSVファイルをpythonで読みこんでみましょう．または，列の順番を変えたり，少し整形して，別の名前のCSVに保存してみましょう．

# Pandas パッケージ

`Pandas`は，データフレームを扱う ***「パッケージ」*** です．「パッケージ」とはモジュール(`.py`ファイル)を集めたフォルダ（ディレクトリ）です．つまり，Pandasはデータフレームを扱うための，クラスおよびクラスメソッド，関数，定数が定義された多数のモジュールが集められたフォルダで，人気があります．

# package

世界の誰かが作ったパッケージを，自分のPCで使うためには，当然ダウンロードしてくる必要があります．

パッケージ（フォルダ）をダウンロードし，自分のソースコードと同じディレクトリに置くと，

```py
from パッケージ名 import そのパッケージの中のモジュール名
```

で使えるようになります．

[ここ](psp2package.zip)にちょこっとしたパッケージを置きました．このzipファイルを解凍すると，
`psp2package`という名前のフォルダが作られます．その中には，`day06package`というフォルダがあり，その中に`mymodule1.py`というモジュールがあり，その中に`hello`という関数が書いてあります．

例えば，この`hello`という関数を動かす場合は，以下のようにします．`from`文にある「`.`」は，フォルダ構造の`/`や`¥`にあたる記号です．

```py
from psp2package.day06package import mymodule1

mymodule1.hello()
```

実は別の読み方があります．

```py
from psp2package.day06package.mymodule1 import *

hello()
```

モジュール名までをすべて`from`に書いて，`import`はモジュールに書いてある関数名です．すべての関数を使いたい場合は`*`を`import`します．このとき，関数呼び出しのしかたが少し違うことに注意してください．
しかし，この関数の呼び出し方は危険です．`hello()`などという関数名は頻出するので，他と重なってしまうからです．最初に紹介しているように`import モジュール名`を強くおすすめします．


ところで，パッケージ名を知っていても，その下のサブディレクトリも知っていなければならないというのは少し不便です．なので，パッケージ（ディレクトリ）のすぐ下に`__init__.py`というパッケージをモジュールのように扱うためのモジュールが作られることが多いです．（これってクラス定義の中に，__init__というメソッドを置くと，クラスを関数のように扱うのと同じです．）

`__init__.py`は，パッケージをモジュールであるかのごとく`import`したときに動かすモジュールです．

今，次のように動かしたいとします．

```py
import psp2package

psp2package.hello()
```

`import`文は指定したモジュールの展開（その場所にモジュールの記述をコピペ）ですので，
`psp2package`モジュールつまり`psp2package/__init__.py`の中は，

```py
from .day06package.mymodule1 import *
```

と書いてあるとよいみたいです．

## PyPIパッケージ: pip package

以前紹介したように，[PyPI](https://pypi.org/)というpythonには公式のパッケージ置き場があります．

PyPIに置いてあるパッケージは`pip`というコマンドでダウンロードされます．
ダウンロードされて，特別な場所に置かれることが決まっています．
また，ダウンロードされるパッケージが，さらに必要としている他のパッケージもダウンロードされます．

```sh
% pip install pandas
```

anaconda-pythonの学生さんは，

```sh
% conda install pandas
```

くだんの「特別な場所」に置かれたパッケージは，今現在動かすソースコードと同じディレクトリではないですが，いきなりパッケージを`from`文で読めることになっています．`pandas`フォルダの下の`io`サブフォルダの下の`parsers.py`というモジュールに書いてある関数をつかいたいなら

```py
from pandas.io import parsers
```

というようにします．

また，さきほど紹介したように`pandas`はパッケージ（フォルダ，ディレクトリ）ですが，すぐ下に`__init__.py`という「モジュールとして呼び出したときに動くモジュール」があるので，

```py
import pandas as pd
```

で呼び出すのが通常です．また，上記のように別名も`pd`とすることが多いです．

# pandas を使ってCSVをデータフレームにする

`pandas`の下の`io`の下の`parsers.py`にCSVファイルをデータフレームにする`read_csv`という関数があります．これを使います．

```sh
>>> import pandas as pd
>>> df1= pd.read_csv('mydata1.csv')
>>> print(type(df1))
<class 'pandas.core.frame.DataFrame'>
>>> print(df1)
                                                                           # mydata1.csv
ID          好きな動物  動物占いの判定  誕生月  セロリ嗜好  所持金の増加（差）    所持金の増加（比）
aa83988848  くま              たぬき         5    嫌い                3192  1.01
>>> print(df1.shape)
(2, 1)
```

データフレームは，`pandas.core.frame.DataFrame`というクラスです．`pandas`の下の`core`の下の`frame.py`というモジュールに`class DataFrame`と定義されています．

クラスに`__str__`メソッドがあるので，このクラスを割り当てられた`df1`を`print`できます．

また，クラスは，独自の属性を持ちます．`self.shape`つまり`df1.shape`はデータフレームの形である`（行数, 列数）`が保存されています．

でも`(2,1)`はおかしいですね．このデータは，`(1,7)`のはずです．

- 列のラベル（測定項目名やアンケート項目名）を **ヘッダ** といいます．このヘッダはデータ本体には数えませんのでデータ本体は`(1,7)`です．

最初の行は，CSV形式でなく単なるメモ書きですので，CSV形式は2行目からです．
読み飛ばす行番号を`skiprows`にリストします．

```sh
>>> df2 = pd.read_csv('mydata1.csv', skiprows=[0])
>>> print(df2.shape)
(1, 7)
>>> print(df2)
           ID  好きな動物  動物占いの判定   誕生月   セロリ嗜好    所持金の増加（差）   所持金の増加（比）
0  aa83988848              くま         たぬき     5                  嫌い  3192    1.01
>>> print(df2.columns)
Index(['ID', ' 好きな動物', ' 動物占いの判定', ' 誕生月', ' セロリ嗜好',
       ' 所持金の増加（差）', ' 所持金の増加（比）'],
      dtype='object')
>>> print(type(df2.columns))
<class 'pandas.core.indexes.base.Index'>
```

CSVファイルを読むと，（読みとばしを無視した）最初の行を「ヘッダ」として理解します．
ヘッダは`self.columns`という属性に`Index`というクラスで保存されています．

CSVによってはヘッダが書かれていない場合があります．`mydata1.csv`で読み飛ばす行の番号を`[0,1]`としてみると

```sh
>>> df3 = pd.read_csv('mydata1.csv', skiprows=[0,1])
>>> print(df3.shape)
(0,  7)
>>> print(df3)
Empty DataFrame
Columns: [aa83988848,  くま,  たぬき,  5,  嫌い,  3192,  1.01]
Index: []
>>> print(df3.columns)
Index(['aa83988848', ' くま', ' たぬき', ' 5', ' 嫌い', ' 3192', ' 1.01'], dtype='object')
```

データ本体の最初のサンプルが間違ってヘッダにされてしまいますので，この場合はヘッダが無いことを明記します．

```sh
>>> df4 = pd.read_csv('mydata1.csv', skiprows=[0,1], header=None)
>>> print(df4.shape)
(1,  7)
>>> print(df4)
            0    1     2  3  4     5   6
0  aa83988848   くま   たぬき  5 嫌い  3192  1.01
>>> print(df4.columns)
Int64Index([0, 1, 2, 3, 4, 5, 6], dtype='int64')
```

カラムラベルが数字になっています．

もし，カラムラベルを指定したいなら読み込んだ後に，

```sh
>>> df4.columns = ['ID', ' 好きな動物', ' 動物占いの判定', ' 誕生月', ' セロリ嗜好',
       ' 所持金の増加（差）', ' 所持金の増加（比）'],
```
と属性columnsを上書きします．

ところで，ヘッダが「表示はされるがデータ本体ではない」のと同様に，`print(df1)`としたときに
最初の列に`0`が表示されています．これはデータ本体ではなく「**インデックス**」と読んでいます．データフレームを作ったときに割り当てられた行番号です．このあとにサンプル行を消したり，行の入れ替えなどをしても，最初のインデクスが維持されます．ヘッダがないときにカラムラベルが数字になったのと同じです．

もし`ID`の列をインデクスにしたいなら，CSVを読むときに，次のように指定します．
ヘッダの行も指定します．読み飛ばし行を読み飛ばしたあとの行番号です．


```sh
>>> df5 = pd.read_csv('mydata1.csv', skiprows=[0], header=0, index_col=0)
>>> print(df5)
            好きな動物  動物占いの判定   誕生月   セロリ嗜好    所持金の増加（差）   所持金の増加（比）
ID                                                                          
aa83988848              くま         たぬき     5                  嫌い  3192    1.01
>>> print(df5.shape)
(1,  6)
>>> print(df5.index)
Index(['aa83988848'], dtype='object', name='ID')
>>> print(df5.index.name)
ID
```

ヘッダ行番号を指定すると，それより上の行は読み飛ばされますので，今の場合，

```sh
>>> df6 = pd.read_csv('mydata1.csv', header=1, index_col=0)
```

でも同じです．

# データフレームの整然化

さて，そんなこんなでCSVを読み込んでデータフレームができたとします．`mydata2.csv`は`mydata1.csv`と同じ項目で
10人からデータをあつめたものです．

``` sh
>>> import pandas as pd
>>> df = pd.read_csv('mydata2.csv')
>>> print(df)
```

IDには被験者やサンプルを区別するラベルが書かれています．学籍番号だったりします．表の表示には必要ですが，データの解析には必要ありません．

なので，

``` sh
>>> import pandas as pd
>>> df = pd.read_csv('mydata2.csv', index_col=0)
>>> print(df)
```

## データフレーム上の値のクラス

データフレーム上の値は以下のように参照できます．

-「好きな動物」だけを全サンプル参照してみます．

```sh
>>> print(df.'好きな動物')

>>> print(type(df.'好きな動物'))

```

- 行番号2（行番号は0からはじまる）のサンプルの「好きな動物」は

```sh
>>> print(df.'好きな動物'[2])
ライオン
>>> print(type(df.'好きな動物'[2]))

```

- 行番号2から4までの3行のサンプルの「好きな動物」は

```sh
>>> print(df.'好きな動物'[2:5])

```

データ集め終えたときに次にやることは，各項目の統計でしょうか．たとえば平均値や標準偏差でしょうか．

そんな統計をまとめて表示してくれる関数がpandasに存在します．

```sh
>>> print(df.summary())
```

値が文字列のところは，表示されず，数値の列だけ表示されます．この関数の中身は，

```sh
>>> print(df.mean())

>>> print(df.median())

>>> print(df.mode())

>>> print(df.sdv())

```
です．

ところで，「誕生月」，「所持金の増加（差）」，「所持金の増加（比）」ですが，その平均や標準偏差ってどんな意味があるのでしょうか？

「所持金の増加（差）」の平均は理解可能です．昨日の所持金に比べ，全員が平均何円増加したかを表しています．標準偏差もその増加額が人によってどのくらい幅があるかです．

「誕生月」はどうでしょうか？おそらくmeanやmedianの結果は，6月周辺の月になっているでしょう．だから何なのでしょう．一番多い誕生月ではありませんね．一番多い誕生月はmode（最貧値）です．誕生月の最貧値は意味がわかります．

「所持金の増加（比）」はどうでしょうか？平均は1周辺にあるのですが，全員が平均何倍増加したかを表していますね．標準偏差はその増加比が人によってどのくらい幅があるかですね．

さて，値が文字列のところも，このような所謂代表値を知りたいです．そのためには文字列を数値に変換しなければいけません．

数値に変えるときには`d = dict({'超嫌い':-2, '嫌い':-1, 'ふつう':0, '好き':1, '超好き':2})`みたいな対応表を用意します．

では，どんな数値でもいいのでしょうか．違います．文字列の解釈に順序があるかないかに気をつける必要があります．

文字列の解釈に優劣，大小，高低，などがあるのなら，その順番で数値を割り当てます．

- 「セロリ嗜好」

まさに「セロリ嗜好」は`d3 = dict({'超嫌い':-2, '嫌い':-1, 'ふつう':0, '好き':1, '超好き':2})`のような感じです．

- 「好きな動物」と「動物占いの判定」

「動物占い」を知ってますか．2000年くらいに流行した「人は12種類の動物に代表される性格があるけど，あなたは？」っていうものです．
ライオン、チータ、ペガサス、ゾウ、猿、狼、子守熊、虎、黒ひょう、ひつじ、たぬき、こじか の12種類です．
単純に誕生日で決まっているようです．

[動物占い公式ページ](https://www.doubutsu-uranai.com)

今回のデータの「好きな動物」と「動物占いの判定」はこの12種類から選ばれるとします．

どんな動物かは順序がありません．よって数値の割り振りは適当で構いません．

`d0 = dict`

- 「誕生月」

「誕生月」は数値でしたが，その解釈に優劣，大小，高低はありません．なのでこれは「好きな動物」の動物の種類と同じ範疇です．




- 「所持金の増加（差）」の尺度

- 「所持金の増加（比）」の尺度


# 課題

1.「好きな動物」がチータの人とゾウの人でセロリ嗜好度は差があると言えるか調べよ．調べるためのコード実行例を示せ．
一般的に双方の四分位範囲が重ならない場合「差がある」と言う．重なっている場合は「差があると言えない」と言う．

※pandas で四分位範囲を求める関数を調べて使うこと．

2. 「好きな動物」がチータの人とゾウのひとでは，どちらが平均的に今日の所持金が多いか？（どちらが増加が大きいかではない）








